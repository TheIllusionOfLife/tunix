17.1s 1 /kaggle/input/google-tunix-hackathon/Hackathon dataset.txt
17.1s 2 /kaggle/input/gemma/flax/2b-it/2/tokenizer.model
17.1s 3 /kaggle/input/gemma/flax/2b-it/2/2b-it/manifest.0000000000000002
17.1s 4 /kaggle/input/gemma/flax/2b-it/2/2b-it/_METADATA
17.1s 5 /kaggle/input/gemma/flax/2b-it/2/2b-it/manifest.ocdbt
17.1s 6 /kaggle/input/gemma/flax/2b-it/2/2b-it/checkpoint
17.1s 7 /kaggle/input/gemma/flax/2b-it/2/2b-it/manifest.0000000000000001
17.1s 8 /kaggle/input/gemma/flax/2b-it/2/2b-it/ocdbt.process_0/manifest.0000000000000002
17.1s 9 /kaggle/input/gemma/flax/2b-it/2/2b-it/ocdbt.process_0/manifest.0000000000000003
17.1s 10 /kaggle/input/gemma/flax/2b-it/2/2b-it/ocdbt.process_0/manifest.ocdbt
17.1s 11 /kaggle/input/gemma/flax/2b-it/2/2b-it/ocdbt.process_0/manifest.0000000000000001
17.1s 12 /kaggle/input/gemma/flax/2b-it/2/2b-it/ocdbt.process_0/d/d5f1ece99269e01acd7a1be9bbaa751d
17.1s 13 /kaggle/input/gemma/flax/2b-it/2/2b-it/ocdbt.process_0/d/c21015490beaedb201ea7ac26b56cfdf
17.1s 14 /kaggle/input/gemma/flax/2b-it/2/2b-it/d/d501557e7c0f1656a4cbf1328f086d0e
17.1s 15 /kaggle/input/grade-school-math-8k-q-a/main_test.csv
17.1s 16 /kaggle/input/grade-school-math-8k-q-a/main_train.csv
17.1s 17 /kaggle/input/grade-school-math-8k-q-a/socratic_train.csv
17.1s 18 /kaggle/input/grade-school-math-8k-q-a/socratic_test.csv
17.1s 19 /kaggle/input/gemma-2/flax/gemma2-2b-it/1/tokenizer.model
17.1s 20 /kaggle/input/gemma-2/flax/gemma2-2b-it/1/gemma2-2b-it/_METADATA
17.1s 21 /kaggle/input/gemma-2/flax/gemma2-2b-it/1/gemma2-2b-it/manifest.ocdbt
17.1s 22 /kaggle/input/gemma-2/flax/gemma2-2b-it/1/gemma2-2b-it/checkpoint
17.1s 23 /kaggle/input/gemma-2/flax/gemma2-2b-it/1/gemma2-2b-it/_CHECKPOINT_METADATA
17.1s 24 /kaggle/input/gemma-2/flax/gemma2-2b-it/1/gemma2-2b-it/ocdbt.process_0/manifest.ocdbt
17.1s 25 /kaggle/input/gemma-2/flax/gemma2-2b-it/1/gemma2-2b-it/ocdbt.process_0/d/834bb4bf1e3854eb09f6208c95c071b2
17.1s 26 /kaggle/input/gemma-2/flax/gemma2-2b-it/1/gemma2-2b-it/ocdbt.process_0/d/bf69258061ae5f35eb7a5669fe6877d4
17.1s 27 /kaggle/input/gemma-2/flax/gemma2-2b-it/1/gemma2-2b-it/ocdbt.process_0/d/fc20151969d7ca91ea9d8275bda0e219
17.1s 28 /kaggle/input/gemma-2/flax/gemma2-2b-it/1/gemma2-2b-it/descriptor/descriptor.pbtxt
17.1s 29 /kaggle/input/gemma-2/flax/gemma2-2b-it/1/gemma2-2b-it/d/b5a4695f4be0a2f41ec1e25616ebd7e7
17.1s 30 âœ“ Asyncio logging suppressed
17.2s 31 
22.8s 32 [33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager, possibly rendering your system unusable. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv. Use the --root-user-action option if you know what you are doing and want to suppress this warning.[0m[33m
22.9s 33 [0m
22.9s 34 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m A new release of pip is available: [0m[31;49m25.0.1[0m[39;49m -> [0m[32;49m25.3[0m
22.9s 35 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m To update, run: [0m[32;49mpip install --upgrade pip[0m
23.9s 36 [33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager, possibly rendering your system unusable. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv. Use the --root-user-action option if you know what you are doing and want to suppress this warning.[0m[33m
23.9s 37 [0m
23.9s 38 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m A new release of pip is available: [0m[31;49m25.0.1[0m[39;49m -> [0m[32;49m25.3[0m
23.9s 39 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m To update, run: [0m[32;49mpip install --upgrade pip[0m
24.9s 40 [33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager, possibly rendering your system unusable. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv. Use the --root-user-action option if you know what you are doing and want to suppress this warning.[0m[33m
25.0s 41 [0m
25.0s 42 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m A new release of pip is available: [0m[31;49m25.0.1[0m[39;49m -> [0m[32;49m25.3[0m
25.0s 43 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m To update, run: [0m[32;49mpip install --upgrade pip[0m
26.0s 44 [33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager, possibly rendering your system unusable. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv. Use the --root-user-action option if you know what you are doing and want to suppress this warning.[0m[33m
26.0s 45 [0m
26.0s 46 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m A new release of pip is available: [0m[31;49m25.0.1[0m[39;49m -> [0m[32;49m25.3[0m
26.0s 47 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m To update, run: [0m[32;49mpip install --upgrade pip[0m
27.0s 48 [33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager, possibly rendering your system unusable. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv. Use the --root-user-action option if you know what you are doing and want to suppress this warning.[0m[33m
27.0s 49 [0m
27.0s 50 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m A new release of pip is available: [0m[31;49m25.0.1[0m[39;49m -> [0m[32;49m25.3[0m
27.0s 51 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m To update, run: [0m[32;49mpip install --upgrade pip[0m
28.0s 52 [33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager, possibly rendering your system unusable. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv. Use the --root-user-action option if you know what you are doing and want to suppress this warning.[0m[33m
28.0s 53 [0m
28.0s 54 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m A new release of pip is available: [0m[31;49m25.0.1[0m[39;49m -> [0m[32;49m25.3[0m
28.0s 55 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m To update, run: [0m[32;49mpip install --upgrade pip[0m
29.1s 56 [33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager, possibly rendering your system unusable. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv. Use the --root-user-action option if you know what you are doing and want to suppress this warning.[0m[33m
29.1s 57 [0m
29.1s 58 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m A new release of pip is available: [0m[31;49m25.0.1[0m[39;49m -> [0m[32;49m25.3[0m
29.1s 59 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m To update, run: [0m[32;49mpip install --upgrade pip[0m
30.1s 60 [33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager, possibly rendering your system unusable. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv. Use the --root-user-action option if you know what you are doing and want to suppress this warning.[0m[33m
30.2s 61 [0m
30.2s 62 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m A new release of pip is available: [0m[31;49m25.0.1[0m[39;49m -> [0m[32;49m25.3[0m
30.2s 63 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m To update, run: [0m[32;49mpip install --upgrade pip[0m
31.2s 64 [33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager, possibly rendering your system unusable. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv. Use the --root-user-action option if you know what you are doing and want to suppress this warning.[0m[33m
31.2s 65 [0m
31.2s 66 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m A new release of pip is available: [0m[31;49m25.0.1[0m[39;49m -> [0m[32;49m25.3[0m
31.2s 67 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m To update, run: [0m[32;49mpip install --upgrade pip[0m
36.5s 68 [33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager, possibly rendering your system unusable. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv. Use the --root-user-action option if you know what you are doing and want to suppress this warning.[0m[33m
57.4s 69 [0m[33mWARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager, possibly rendering your system unusable. It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv. Use the --root-user-action option if you know what you are doing and want to suppress this warning.[0m[33m
57.4s 70 [0m
57.4s 71 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m A new release of pip is available: [0m[31;49m25.0.1[0m[39;49m -> [0m[32;49m25.3[0m
57.4s 72 [1m[[0m[34;49mnotice[0m[1;39;49m][0m[39;49m To update, run: [0m[32;49mpip install --upgrade pip[0m
59.6s 73 JAX version: 0.8.0
59.6s 74 Flax version: 0.12.0
60.7s 75 âœ“ WandB API key loaded
78.9s 76 âœ“ All imports successful
78.9s 77 JAX version: 0.8.0
78.9s 78 Flax version: 0.12.0
79.0s 79 WARNING: Logging before InitGoogle() is written to STDERR
79.0s 80 E0000 00:00:1763155215.099985      74 common_lib.cc:648] Could not set metric server port: INVALID_ARGUMENT: Could not find SliceBuilder port 8471 in any of the 0 ports provided in `tpu_process_addresses`="local"
79.0s 81 === Source Location Trace: ===
79.0s 82 learning/45eac/tfrc/runtime/common_lib.cc:238
79.2s 83 WARNING: Logging before InitGoogle() is written to STDERR
79.2s 84 E0000 00:00:1763155215.099985      74 common_lib.cc:648] Could not set metric server port: INVALID_ARGUMENT: Could not find SliceBuilder port 8471 in any of the 0 ports provided in `tpu_process_addresses`="local"
79.2s 85 === Source Location Trace: ===
79.2s 86 learning/45eac/tfrc/runtime/common_lib.cc:238
79.2s 87 
79.2s 88 WARNING: Logging before InitGoogle() is written to STDERR
79.2s 89 E0000 00:00:1763155215.099985      74 common_lib.cc:648] Could not set metric server port: INVALID_ARGUMENT: Could not find SliceBuilder port 8471 in any of the 0 ports provided in `tpu_process_addresses`="local"
79.2s 90 === Source Location Trace: ===
79.2s 91 learning/45eac/tfrc/runtime/common_lib.cc:238
87.0s 92 JAX devices: [TpuDevice(id=0, process_index=0, coords=(0,0,0), core_on_chip=0), TpuDevice(id=1, process_index=0, coords=(1,0,0), core_on_chip=0), TpuDevice(id=2, process_index=0, coords=(0,1,0), core_on_chip=0), TpuDevice(id=3, process_index=0, coords=(1,1,0), core_on_chip=0), TpuDevice(id=4, process_index=0, coords=(0,2,0), core_on_chip=0), TpuDevice(id=5, process_index=0, coords=(1,2,0), core_on_chip=0), TpuDevice(id=6, process_index=0, coords=(0,3,0), core_on_chip=0), TpuDevice(id=7, process_index=0, coords=(1,3,0), core_on_chip=0)]
87.0s 93 Configuration set:
87.0s 94 MAX_STEPS: 100
87.0s 95 TRAIN_MICRO_BATCH_SIZE: 1
87.0s 96 NUM_GENERATIONS: 2
87.0s 97 TOTAL_GENERATION_STEPS: 256
87.2s 98 Using data source: kaggle
87.3s 99 Copied main_test.csv â†’ data/train/main_test.csv
87.5s 100 Copied main_train.csv â†’ data/train/main_train.csv
87.5s 101 Copied socratic_train.csv â†’ data/train/socratic_train.csv
87.5s 102 Copied socratic_test.csv â†’ data/train/socratic_test.csv
87.6s 103 Copied main_test.csv â†’ data/test/main_test.csv
87.6s 104 Copied main_train.csv â†’ data/test/main_train.csv
87.6s 105 Copied socratic_train.csv â†’ data/test/socratic_train.csv
87.6s 106 Copied socratic_test.csv â†’ data/test/socratic_test.csv
87.6s 107 dataset contains (100, 0, 50) of batches
87.6s 108 {'answer': array(['3'], dtype='<U1'),
87.6s 109 'prompts': array(['<start_of_turn>user\nYou are given a problem. Think about the problem and provide your reasoning. Place it between <reasoning> and </reasoning>. Then, provide the final answer (i.e., just one numerical value) between <answer> and </answer>.\n\nMaria has 4 dimes, 4 quarters, and 7 nickels in her piggy bank. Her mom gives her 5 quarters. How much money, in dollars, does Maria have now?<end_of_turn>\n<start_of_turn>model'],
87.6s 110 dtype='<U417'),
87.6s 111 'question': array(['Maria has 4 dimes, 4 quarters, and 7 nickels in her piggy bank. Her mom gives her 5 quarters. How much money, in dollars, does Maria have now?'],
87.6s 112 dtype='<U142')}
87.8s 113 google/gemma-2/flax/gemma2-2b-it
89.5s 114 WARNING:absl:`StandardCheckpointHandler` expects a target tree to be provided for restore. Not doing so is generally UNSAFE unless you know the present topology to be the same one as the checkpoint was saved under.
89.5s 115 
89.5s 116 WARNING:absl:`StandardCheckpointHandler` expects a target tree to be provided for restore. Not doing so is generally UNSAFE unless you know the present topology to be the same one as the checkpoint was saved under.
89.8s 117 Loading Gemma2-2B-IT model parameters...
100.3s 118 âœ“ Parameters loaded
100.3s 119 Creating Transformer model...
100.7s 120 âœ“ Transformer created
100.7s 121 Saving intermediate checkpoint...
139.7s 122 âœ“ Checkpoint saved
139.7s 123 âœ“ Memory cleaned
139.9s 124 Creating TPU mesh...
139.9s 125 âœ“ Mesh created: Mesh('fsdp': 1, 'tp': 4, axis_types=(Auto, Auto))
139.9s 126 Loading reference model...
143.0s 127 âœ“ Reference model loaded
156.1s 128 Traceback (most recent call last):
156.1s 129 File "<string>", line 1, in <module>
156.1s 130 File "/usr/local/lib/python3.12/site-packages/papermill/execute.py", line 131, in execute_notebook
156.1s 131 raise_for_execution_errors(nb, output_path)
156.1s 132 File "/usr/local/lib/python3.12/site-packages/papermill/execute.py", line 251, in raise_for_execution_errors
156.1s 133 raise error
156.1s 134 papermill.exceptions.PapermillExecutionError:
156.1s 135 ---------------------------------------------------------------------------
156.1s 136 Exception encountered at "In [19]":
156.1s 137 ---------------------------------------------------------------------------
156.1s 138 TypeError                                 Traceback (most recent call last)
156.1s 139 Cell In[19], line 2
156.1s 140 1 # Policy model
156.1s 141 ----> 2 lora_policy = get_lora_model(ref_model, mesh=mesh)
156.1s 142 3 nnx.display(lora_policy)
156.1s 143 
156.1s 144 Cell In[17], line 31, in get_lora_model(base_model, mesh)
156.1s 145 21 lora_provider = qwix.LoraProvider(
156.1s 146 22     module_path=(
156.1s 147 23         ".*q_einsum|.*kv_einsum|.*gate_proj|.*down_proj|.*up_proj|"
156.1s 148 (...)     27     alpha=ALPHA,
156.1s 149 28 )
156.1s 150 30 model_input = base_model.get_model_input()
156.1s 151 ---> 31 lora_model = qwix.apply_lora_to_model(
156.1s 152 32     base_model, lora_provider, **model_input
156.1s 153 33 )
156.1s 154 35 with mesh:
156.1s 155 36     state = nnx.state(lora_model)
156.1s 156 
156.1s 157 File /usr/local/lib/python3.12/site-packages/qwix/_src/model.py:60, in quantize_model(model, provider, methods, *model_inputs, **model_inputs_kwargs)
156.1s 158 58   if len(methods) != 1:
156.1s 159 59     raise ValueError("Only one method is supported for nnx models.")
156.1s 160 ---> 60   return quantize_nnx_model(
156.1s 161 61       model,
156.1s 162 62       provider,
156.1s 163 63       *model_inputs,
156.1s 164 64       call_method=next(iter(methods)),
156.1s 165 65       **model_inputs_kwargs,
156.1s 166 66   )
156.1s 167 67 else:
156.1s 168 68   raise ValueError(f"Unsupported model type: {type(model)}")
156.1s 169 
156.1s 170 File /usr/local/lib/python3.12/site-packages/qwix/_src/model.py:193, in quantize_nnx_model(model, provider, call_method, *model_inputs, **model_inputs_kwargs)
156.1s 171 190 # Because nnx modules are stateful, we need to call them once to initialize
156.1s 172 191 # them (convert weights, create quant_stats) unless users explicitly opt out.
156.1s 173 192 if not model_inputs_kwargs.get("skip_nnx_init"):
156.1s 174 --> 193   getattr(model, call_method)(*model_inputs, **model_inputs_kwargs)
156.1s 175 195 # Enable quant_stats update for subsequent calls.
156.1s 176 196 for _, module in model.iter_modules():
156.1s 177 
156.1s 178 File /usr/local/lib/python3.12/site-packages/qwix/_src/interception.py:166, in wrap_func_intercepted.<locals>.wrapper(*args, **kwargs)
156.1s 179 164   jax.config.update("jax_disable_jit", True)
156.1s 180 165 try:
156.1s 181 --> 166   output = func(*args, **kwargs)
156.1s 182 167 finally:
156.1s 183 168   if need_to_disable_jit:
156.1s 184 
156.1s 185 File /usr/local/lib/python3.12/site-packages/tunix/models/gemma/model.py:911, in Transformer.__call__(self, last_tokens, positions, cache, attention_mask, output_hidden_states)
156.1s 186 909 layer_name = f'layer_{i}'
156.1s 187 910 layer_cache = cache[layer_name] if cache else None
156.1s 188 --> 911 layer_cache, x = layer(
156.1s 189 912     x,
156.1s 190 913     positions,
156.1s 191 914     layer_cache,
156.1s 192 915     attention_mask,
156.1s 193 916 )
156.1s 194 917 if cache is not None:
156.1s 195 918   new_cache[layer_name] = layer_cache  # pytype: disable=container-type-mismatch
156.1s 196 
156.1s 197 File /usr/local/lib/python3.12/site-packages/tunix/models/gemma/model.py:632, in Block.__call__(self, x, segment_pos, cache, attn_mask)
156.1s 198 624 def __call__(
156.1s 199 625     self,
156.1s 200 626     x: jaxtyping.Array,
156.1s 201 (...)    629     attn_mask: jaxtyping.Array,
156.1s 202 630 ) -> tuple[LayerCache | None, jaxtyping.Array]:
156.1s 203 631   inputs_normalized = self.pre_attention_norm(x)
156.1s 204 --> 632   cache, attn_output = self.attn(
156.1s 205 633       inputs_normalized,
156.1s 206 634       segment_pos,
156.1s 207 635       cache,
156.1s 208 636       attn_mask,
156.1s 209 637   )
156.1s 210 639   if self.use_post_attn_norm:
156.1s 211 640     attn_output = self.post_attn_norm(attn_output)
156.1s 212 
156.1s 213 File /usr/local/lib/python3.12/contextlib.py:81, in ContextDecorator.__call__.<locals>.inner(*args, **kwds)
156.1s 214 78 @wraps(func)
156.1s 215 79 def inner(*args, **kwds):
156.1s 216 80     with self._recreate_cm():
156.1s 217 ---> 81         return func(*args, **kwds)
156.1s 218 
156.1s 219 File /usr/local/lib/python3.12/site-packages/tunix/models/gemma/model.py:489, in Attention.__call__(self, x, segment_pos, cache, attn_mask)
156.1s 220 485   return nnx.remat(self.block.__func__)(
156.1s 221 486       self, x, segment_pos, cache, attn_mask
156.1s 222 487   )
156.1s 223 488 else:
156.1s 224 --> 489   return self.block(x, segment_pos, cache, attn_mask)
156.1s 225 
156.1s 226 File /usr/local/lib/python3.12/site-packages/tunix/models/gemma/model.py:385, in Attention.block(self, x, segment_pos, cache, attn_mask)
156.1s 227 383   query_proj, key_proj, value_proj = self.qkv_einsum(x)
156.1s 228 384 else:
156.1s 229 --> 385   query_proj = self.q_einsum(x)
156.1s 230 386   key_proj, value_proj = self.kv_einsum(x)
156.1s 231 388 query_proj = shard(query_proj, self.shd_config.act_btnh)
156.1s 232 
156.1s 233 File /usr/local/lib/python3.12/contextlib.py:81, in ContextDecorator.__call__.<locals>.inner(*args, **kwds)
156.1s 234 78 @wraps(func)
156.1s 235 79 def inner(*args, **kwds):
156.1s 236 80     with self._recreate_cm():
156.1s 237 ---> 81         return func(*args, **kwds)
156.1s 238 
156.1s 239 File /usr/local/lib/python3.12/site-packages/tunix/models/gemma/model.py:257, in Einsum.__call__(self, x)
156.1s 240 255 @jax.named_scope('einsum')
156.1s 241 256 def __call__(self, x: jaxtyping.ArrayLike) -> jaxtyping.Array:
156.1s 242 --> 257   return jnp.einsum(self.einsum_str, x, self.w.value)
156.1s 243 
156.1s 244 File /usr/local/lib/python3.12/site-packages/qwix/_src/interception.py:247, in _fn_to_code.<locals>.wrapper(*args, **kwargs)
156.1s 245 244 from qwix._src import aux_data  # pylint: disable=g-import-not-at-top,redefined-outer-name,reimported
156.1s 246 246 fn = aux_data.get(inspect.currentframe().f_code, "fn")  # pytype: disable=attribute-error
156.1s 247 --> 247 return fn(*args, **kwargs)
156.1s 248 
156.1s 249 File /usr/local/lib/python3.12/site-packages/qwix/_src/interception.py:196, in _wrap_to_call_original_if_needed.<locals>.wrapper(*args, **kwargs)
156.1s 250 194 _intercepted_threads[key] = False
156.1s 251 195 try:
156.1s 252 --> 196   return intercept_fn(*args, **kwargs)
156.1s 253 197 finally:
156.1s 254 198   _intercepted_threads[key] = True
156.1s 255 
156.1s 256 File /usr/local/lib/python3.12/site-packages/qwix/_src/providers/lora.py:227, in LoraProvider.einsum(self, einsum_str, *operands, **kwargs)
156.1s 257 224 module = flax_util.get_current_module()
156.1s 258 225 setattr(module, weight_name + '_lora_einsum_str', lora_einsum_str)
156.1s 259 --> 227 lora_a, lora_b, dropout_layer = _get_or_create_lora_params(
156.1s 260 228     name=weight_name,
156.1s 261 229     rule=rule,
156.1s 262 230     a_shape=a_shape,
156.1s 263 231     b_shape=b_shape,
156.1s 264 232     a_sharding_transpose=a_sharding_transpose,
156.1s 265 233     b_sharding_transpose=b_sharding_transpose,
156.1s 266 234 )
156.1s 267 236 if dropout_layer is not None:
156.1s 268 237   # TODO(zhuyunx): Use nnx.Rngs(0) for now. Need to check `deterministic`
156.1s 269 238   # to decide whether to provide a rng.
156.1s 270 239   # NOTE: this is wrong because it always uses the same rng.
156.1s 271 240   lhs = dropout_layer(lhs, rngs=nnx.Rngs(0))
156.1s 272 
156.1s 273 File /usr/local/lib/python3.12/site-packages/qwix/_src/providers/lora.py:395, in _get_or_create_lora_params(name, rule, a_shape, b_shape, a_sharding_transpose, b_sharding_transpose)
156.1s 274 392     return nnx.VariableMetadata(value.value, metadata=value.get_metadata())
156.1s 275 393   return value
156.1s 276 --> 395 lora_a = flax_util.get_or_create_param(
156.1s 277 396     name + '_lora_a',
156.1s 278 397     lambda: init(rule.lora_a_initializer, a_shape, a_sharding_transpose),
156.1s 279 398     nnx.LoRAParam,
156.1s 280 399 )
156.1s 281 400 lora_b = flax_util.get_or_create_param(
156.1s 282 401     name + '_lora_b',
156.1s 283 402     lambda: init(rule.lora_b_initializer, b_shape, b_sharding_transpose),
156.1s 284 403     nnx.LoRAParam,
156.1s 285 404 )
156.1s 286 405 return lora_a, lora_b, dropout_layer
156.1s 287 
156.1s 288 File /usr/local/lib/python3.12/site-packages/qwix/_src/flax_util.py:174, in get_or_create_param(name, init_fn, nnx_param_type)
156.1s 289 172   _check_shape(param.value, init_fn)
156.1s 290 173 else:
156.1s 291 --> 174   param = jax.tree.map(nnx_param_type, init_fn())
156.1s 292 175   setattr(module, name, param)
156.1s 293 176 return unbox(param)
156.1s 294 
156.1s 295 File /usr/local/lib/python3.12/site-packages/qwix/_src/providers/lora.py:397, in _get_or_create_lora_params.<locals>.<lambda>()
156.1s 296 392     return nnx.VariableMetadata(value.value, metadata=value.get_metadata())
156.1s 297 393   return value
156.1s 298 395 lora_a = flax_util.get_or_create_param(
156.1s 299 396     name + '_lora_a',
156.1s 300 --> 397     lambda: init(rule.lora_a_initializer, a_shape, a_sharding_transpose),
156.1s 301 398     nnx.LoRAParam,
156.1s 302 399 )
156.1s 303 400 lora_b = flax_util.get_or_create_param(
156.1s 304 401     name + '_lora_b',
156.1s 305 402     lambda: init(rule.lora_b_initializer, b_shape, b_sharding_transpose),
156.1s 306 403     nnx.LoRAParam,
156.1s 307 404 )
156.1s 308 405 return lora_a, lora_b, dropout_layer
156.1s 309 
156.1s 310 File /usr/local/lib/python3.12/site-packages/qwix/_src/providers/lora.py:390, in _get_or_create_lora_params.<locals>.init(initializer, shape, transpose)
156.1s 311 388   lora_pspec = flax_util.update_sharding(sharding.spec, transpose=transpose)
156.1s 312 389   value = jax.device_put(value, sharding.update(spec=lora_pspec))
156.1s 313 --> 390 value = flax_util.update_boxed(boxed, value=value, transpose=transpose)
156.1s 314 391 if isinstance(value, nnx.Variable):
156.1s 315 392   return nnx.VariableMetadata(value.value, metadata=value.get_metadata())
156.1s 316 
156.1s 317 File /usr/local/lib/python3.12/site-packages/qwix/_src/flax_util.py:359, in update_boxed(boxed, value, split, merge, transpose)
156.1s 318 355   if isinstance(axes, (list, tuple)):
156.1s 319 356     axes = update_sharding(
156.1s 320 357         axes, shape=shape, split=split, merge=merge, transpose=transpose
156.1s 321 358     )
156.1s 322 --> 359     boxed.set_metadata('sharding_names', axes)
156.1s 323 360 elif isinstance(boxed, jax.Array):  # not boxed.
156.1s 324 361   if value is not None:
156.1s 325 
156.1s 326 File /usr/local/lib/python3.12/site-packages/flax/nnx/variablelib.py:392, in Variable.set_metadata(self, *args, **kwargs)
156.1s 327 390   self._var_metadata.update(kwargs)
156.1s 328 391 else:
156.1s 329 --> 392   raise TypeError(
156.1s 330 393     f'set_metadata takes either 1 argument or 1 or more keyword arguments, got args={args}, kwargs={kwargs}'
156.1s 331 394   )
156.1s 332 
156.1s 333 TypeError: set_metadata takes either 1 argument or 1 or more keyword arguments, got args=('sharding_names', ('fsdp', None)), kwargs={}
156.1s 334 
159.0s 335 [NbConvertApp] Converting notebook __notebook__.ipynb to notebook
159.3s 336 [NbConvertApp] Writing 126353 bytes to __notebook__.ipynb
161.6s 337 [NbConvertApp] Converting notebook __notebook__.ipynb to html
163.0s 338 [NbConvertApp] Writing 488948 bytes to __results__.html